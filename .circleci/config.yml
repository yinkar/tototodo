version: 2.1

orbs:
  gcp-cli: circleci/gcp-cli@2.2.0

jobs:
  build:
    docker:
      - image: cimg/base:stable

    environment: /tmp/test-results

    steps:
      - checkout
      
      - setup_remote_docker:
          version: 19.03.13

      - run:
          name: Install Docker client
          command: |
            sudo apt-get update && sudo apt-get install docker

      - run:
          name: Install Docker Compose
          command: |
            sudo apt-get update && sudo apt-get install docker-compose

      - run:
          name: Build
          command: docker-compose build

      - run:
          name: Run backend tests
          command: |
            (cd ./backend && godog)

      - setup_remote_docker

      - run:
          name: Run frontend tests
          command: |
            (cd ./frontend && npm run test:e2e)

      - setup_remote_docker

      - run:
          name: Start
          command: docker-compose up -d

      - store_artifacts:
          path: /tmp/test-results
          destination: raw-test-output

      - store_test_results:
          path: /tmp/test-results

  deploy:
    executor: gcp-cli/default
    steps:
      - gcp-cli/install
      - gcp-cli/initialize
      
      - run:
          name: deploy service
          command: |
            export cmd='sudo docker stop $(docker ps -a -q) || true && sudo docker rm $(docker ps -a -q) || true && docker image prune -a -f || true && docker run -d -p 80:5000'
            gcloud --quiet compute ssh  "$GCE_INSTANCE_NAME" --tunnel-through-iap --command="$cmd $IMAGE_NAME"
